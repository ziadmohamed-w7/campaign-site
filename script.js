/* ===== ููู JavaScript ุงููุญุณูู ูููููุน ===== */

// =====================================
// 1. ุฅุนุฏุงุฏุงุช ุนุงูุฉ ูุซูุงุจุช
// =====================================
const CONFIG = {
  PETITION_URL: 'https://forms.gle/GdPd6QE9GkbYQeiV9',
  PETITION_LINK: "https://docs.google.com/forms/d/e/1FAIpQLSfxsw43WwwSXzad5Vt8hJDMzIhTECoUCNLvmVJ0u9KAFHEyQQ/viewform",
  SITE_URL: window.location.href,
  HASHTAG: '#ุงูุชุฑูุช_ุบูุฑ_ูุญุฏูุฏ_ูุงNTRA',
  TOAST_DURATION: 3000,
  WELCOME_SCREEN_DURATION: 2000
};

// =====================================
// 2. ุฅุฏุงุฑุฉ ุดุงุดุฉ ุงูุชุฑุญูุจ
// =====================================
function initWelcomeScreen() {
  const welcomeScreen = document.getElementById('welcomeScreen');
  if (!welcomeScreen) return;

  setTimeout(() => {
    welcomeScreen.classList.add('hide');
    setTimeout(() => {
      welcomeScreen.style.display = 'none';
    }, 600);
  }, CONFIG.WELCOME_SCREEN_DURATION);
}

// =====================================
// 3. ุฅุฏุงุฑุฉ ุงููุงุฆูุฉ ุงููุชุฌุงูุจุฉ
// =====================================
function initMobileMenu() {
  const menuToggle = document.getElementById('menuToggle');
  const navLinks = document.getElementById('navLinks');
  
  if (!menuToggle || !navLinks) return;

  menuToggle.addEventListener('click', () => {
    menuToggle.classList.toggle('active');
    navLinks.classList.toggle('active');
  });

  // ุฅุบูุงู ุงููุงุฆูุฉ ุนูุฏ ุงูููุฑ ุนูู ุฑุงุจุท
  navLinks.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', () => {
      menuToggle.classList.remove('active');
      navLinks.classList.remove('active');
    });
  });

  // ุฅุบูุงู ุงููุงุฆูุฉ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
  document.addEventListener('click', (e) => {
    if (!menuToggle.contains(e.target) && !navLinks.contains(e.target)) {
      menuToggle.classList.remove('active');
      navLinks.classList.remove('active');
    }
  });
}

// =====================================
// 4. ุงููุถุน ุงููููู
// =====================================
function initDarkMode() {
  const darkToggle = document.getElementById('darkToggle');
  if (!darkToggle) return;

  // ุชุญููู ุงูุฅุนุฏุงุฏ ุงููุญููุธ
  const savedMode = localStorage.getItem('darkMode');
  if (savedMode === 'enabled') {
    document.body.classList.add('dark-mode');
    updateDarkModeIcon(true);
  }

  darkToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    
    localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
    updateDarkModeIcon(isDark);
    showToast(isDark ? 'ุชู ุชูุนูู ุงููุถุน ุงููููู ๐' : 'ุชู ุชูุนูู ุงููุถุน ุงูููุงุฑู โ๏ธ');
  });
}

function updateDarkModeIcon(isDark) {
  const icon = document.querySelector('#darkToggle i');
  if (icon) {
    icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
  }
}

// =====================================
// 5. ุชุจุฏูู ุงููุบุฉ (ุงูุนุฑุจูุฉ/ุงูุฅูุฌููุฒูุฉ)
// =====================================
const translations = {
  ar: {
    welcomeTitle: 'ูุฑุญุจุงู ุจู',
    welcomeSubtitle: 'ูุนูุง ูุญู ุฅูุชุฑูุช ุฃูุถู',
    bannerText: 'ุงููููุน ุงูุฑุณูู ูุญููุฉ ุงูุงูุชุฑูุช ุงูุบูุฑ ูุญุฏูุฏ ูู ูุตุฑ',
    siteTitle: 'ุงูุงูุชุฑูุช ูู ูุตุฑ',
    // ูููู ุฅุถุงูุฉ ุงููุฒูุฏ ูู ุงูุชุฑุฌูุงุช ุญุณุจ ุงูุญุงุฌุฉ
  },
  en: {
    welcomeTitle: 'Welcome',
    welcomeSubtitle: 'Together for Better Internet',
    bannerText: 'Official Website for Unlimited Internet Campaign in Egypt',
    siteTitle: 'Internet in Egypt',
    // ูููู ุฅุถุงูุฉ ุงููุฒูุฏ ูู ุงูุชุฑุฌูุงุช ุญุณุจ ุงูุญุงุฌุฉ
  }
};

function initLanguageToggle() {
  const langToggle = document.getElementById('langToggle');
  if (!langToggle) return;

  let currentLang = localStorage.getItem('language') || 'ar';
  applyLanguage(currentLang);

  langToggle.addEventListener('click', () => {
    currentLang = currentLang === 'ar' ? 'en' : 'ar';
    localStorage.setItem('language', currentLang);
    applyLanguage(currentLang);
    showToast(currentLang === 'ar' ? 'ุชู ุงูุชุจุฏูู ููุนุฑุจูุฉ' : 'Switched to English');
  });
}

function applyLanguage(lang) {
  document.querySelectorAll('[data-translate]').forEach(element => {
    const key = element.getAttribute('data-translate');
    if (translations[lang] && translations[lang][key]) {
      element.textContent = translations[lang][key];
    }
  });

  // ุชุจุฏูู ุงูุนูุงุตุฑ ุจูุงุกู ุนูู ุงููุบุฉ
  document.querySelectorAll('[lang="ar"]').forEach(el => {
    el.style.display = lang === 'ar' ? '' : 'none';
  });
  document.querySelectorAll('[lang="en"]').forEach(el => {
    el.style.display = lang === 'en' ? '' : 'none';
  });

  // ุชุบููุฑ ุงุชุฌุงู ุงูุตูุญุฉ
  document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
  document.documentElement.setAttribute('lang', lang);
}

// =====================================
// 6. ุฅุฏุงุฑุฉ ุงููุฑุงุญู (Toggle Steps)
// =====================================
function toggleSteps(button) {
  const stepsList = button.nextElementSibling;
  const icon = button.querySelector('i');
  
  if (!stepsList) return;

  stepsList.classList.toggle('active');
  button.classList.toggle('active');
  
  if (icon) {
    icon.className = stepsList.classList.contains('active') 
      ? 'fas fa-chevron-up' 
      : 'fas fa-chevron-down';
  }

  // ุชุญุฏูุซ ูุต ุงูุฒุฑ
  const buttonText = button.querySelector('span');
  if (buttonText) {
    const isArabic = document.documentElement.lang === 'ar';
    buttonText.textContent = stepsList.classList.contains('active')
      ? (isArabic ? 'ุฅุฎูุงุก ุงูุฎุทูุงุช' : 'Hide Steps')
      : (isArabic ? 'ุงุนุฑุถ ุงูุฎุทูุงุช' : 'Show Steps');
  }
}

// =====================================
// 7. ุฅุฏุงุฑุฉ ุงููุดุงุฑูุฉ ุนุจุฑ ูุณุงุฆู ุงูุชูุงุตู
// =====================================
function shareToWhatsApp() {
  const text = encodeURIComponent(`ุงูุถู ูุญููุฉ #ุงูุชุฑูุช_ุบูุฑ_ูุญุฏูุฏ_ูู_ูุตุฑ ูุดุงุฑู ุตูุชู ูุนูุง!\n${CONFIG.SITE_URL}`);
  const url = `https://wa.me/?text=${text}`;
  
  const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
  if (newWindow) newWindow.opener = null;
  
  trackClick('WhatsApp Share');
}

function shareToTelegram() {
  const text = encodeURIComponent(`ุงูุถู ูุญููุฉ #ุงูุชุฑูุช_ุบูุฑ_ูุญุฏูุฏ_ูู_ูุตุฑ`);
  const url = `https://t.me/share/url?url=${CONFIG.SITE_URL}&text=${text}`;
  
  const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
  if (newWindow) newWindow.opener = null;
  
  trackClick('Telegram Share');
}

function shareToFacebook() {
  const url = `https://www.facebook.com/sharer/sharer.php?u=${CONFIG.SITE_URL}`;
  
  const newWindow = window.open(url, '_blank', 'noopener,noreferrer,width=600,height=400');
  if (newWindow) newWindow.opener = null;
  
  trackClick('Facebook Share');
}

function shareToTwitter() {
  const hashtag = CONFIG.HASHTAG;
  const text = `${hashtag} - ุงูุถู ููุญููุฉ ุงูุขู!`;
  const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${CONFIG.SITE_URL}`;
  
  const newWindow = window.open(url, '_blank', 'noopener,noreferrer,width=550,height=420');
  if (newWindow) newWindow.opener = null;
  
  trackClick('Twitter Share');
}

// =====================================
// 8. ูุณุฎ ุงููุตูุต (Hashtag, Links, Tweets)
// =====================================
function copyHashtag() {
  copyToClipboard(CONFIG.HASHTAG, 'ุชู ูุณุฎ ุงููุงุดุชุงุฌ! โ');
  trackClick('Copy Hashtag');
}

function copyPetitionLink() {
  copyToClipboard(CONFIG.PETITION_LINK, 'ุชู ูุณุฎ ุฑุงุจุท ุงูุนุฑูุถุฉ โ');
  trackClick('Copy Petition Link');
}

function copyToClipboard(text, successMessage) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text)
      .then(() => showToast(successMessage))
      .catch(() => fallbackCopy(text, successMessage));
  } else {
    fallbackCopy(text, successMessage);
  }
}

function fallbackCopy(text, successMessage) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.opacity = '0';
  textArea.style.pointerEvents = 'none';
  document.body.appendChild(textArea);
  textArea.select();
  
  try {
    document.execCommand('copy');
    showToast(successMessage || 'ุชู ุงููุณุฎ!');
  } catch (err) {
    showToast('ูุดู ุงููุณุฎุ ุญุงูู ูุฑุฉ ุฃุฎุฑู');
    console.error('Copy failed:', err);
  }
  
  document.body.removeChild(textArea);
}

// =====================================
// 9. ุฅุดุนุงุฑุงุช Toast
// =====================================
function showToast(message) {
  // ุฅุฒุงูุฉ ุฃู toast ููุฌูุฏ
  const existingToast = document.querySelector('.toast');
  if (existingToast) {
    existingToast.remove();
  }
  
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  document.body.appendChild(toast);
  
  // ุฅุธูุงุฑ ุงูุชูุณุช
  setTimeout(() => toast.classList.add('show'), 100);
  
  // ุฅุฎูุงุก ุงูุชูุณุช
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, CONFIG.TOAST_DURATION);
}

// =====================================
// 10. ูุชุญ ุงูุนุฑูุถุฉ ูุงููุดุงุฑูุฉ
// =====================================
function openPetition() {
  // ูุชุญ ูู ูุงูุฐุฉ/ุชุงุจ ุฌุฏูุฏ ุจุฏูู ุงูุนูุฏุฉ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ
  const newWindow = window.open(CONFIG.PETITION_URL, '_blank', 'noopener,noreferrer');
  
  // ุงูุชุฃูุฏ ูู ูุชุญ ุงูุฑุงุจุท ุญุชู ูู ูุงู popup blocker ููุนู
  if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
    // ุฅุฐุง ูุดู ุงููุชุญ ูู ูุงูุฐุฉ ุฌุฏูุฏุฉุ ููุชุญู ูู ููุณ ุงููุงูุฐุฉ
    window.location.href = CONFIG.PETITION_URL;
  } else {
    // ููุน ุงูุตูุญุฉ ุงูุญุงููุฉ ูู ุงูุชุบููุฑ
    newWindow.opener = null;
  }
  
  trackClick('Open Petition');
}

function openShare() {
  const shareData = {
    title: 'ุญููุฉ ุงูุฅูุชุฑูุช ุบูุฑ ุงููุญุฏูุฏ',
    text: 'ุงูุถู ูุญููุฉ #ุงูุชุฑูุช_ุบูุฑ_ูุญุฏูุฏ_ูู_ูุตุฑ ูุดุงุฑู ุตูุชู ูุนูุง!',
    url: CONFIG.SITE_URL
  };

  if (navigator.share) {
    navigator.share(shareData)
      .then(() => trackClick('Native Share Success'))
      .catch(() => fallbackCopy(shareData.url, 'โ ุชู ูุณุฎ ุงูุฑุงุจุท!'));
  } else {
    fallbackCopy(shareData.url, 'โ ุชู ูุณุฎ ุงูุฑุงุจุท!');
  }
}

// =====================================
// 11. ูุณุฎ ุงูุชุบุฑูุฏุงุช ุงููููุฐุฌูุฉ
// =====================================
function initTweetCopyButtons() {
  document.querySelectorAll('.copy-tweet-btn').forEach(button => {
    button.addEventListener('click', function() {
      const tweetCard = this.closest('.sample-tweet');
      const tweetText = tweetCard.querySelector('p').textContent.trim();
      
      copyToClipboard(tweetText, 'ุชู ูุณุฎ ุงูุชุบุฑูุฏุฉ! โ');
      tweetCard.classList.add('copied');
      
      setTimeout(() => {
        tweetCard.classList.remove('copied');
      }, 2000);
    });
  });
}

// =====================================
// 12. ุงูุชูุฑูุฑ ุงูุณูุณ ููุฑูุงุจุท ุงูุฏุงุฎููุฉ
// =====================================
function initSmoothScroll() {
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
      const targetId = this.getAttribute('href');
      if (targetId === '#') return;
      
      const targetElement = document.querySelector(targetId);
      if (targetElement) {
        e.preventDefault();
        targetElement.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });
}

// =====================================
// 13. ุชุชุจุน ุงูููุฑุงุช ูุงูุชุญูููุงุช
// =====================================
function trackClick(action) {
  console.log('๐ Track:', action, new Date().toLocaleString('ar-EG'));
  
  // ุฅุฑุณุงู ูู Google Analytics ุฅุฐุง ูุงู ูุชุงุญุงู
  if (typeof gtag === 'function') {
    gtag('event', 'click', {
      event_category: 'engagement',
      event_label: action
    });
  }
}

// =====================================
// 14. ุชุญุฏูุซ ุนุฏุฏ ุงูุชูููุนุงุช (ุฏููุงูููู)
// =====================================
function updatePetitionCount() {
  const countElement = document.getElementById('count');
  if (!countElement) return;
  
  // ูููู ุชุญุฏูุซ ูุฐุง ูู API ุฃู ูุงุนุฏุฉ ุจูุงูุงุช
  // ุญุงููุงู ูุณุชุฎุฏู ูููุฉ ุซุงุจุชุฉ
  const currentCount = '4.8 ุงูู';
  countElement.textContent = currentCount;
}

// =====================================
// 15. ุชุญุณูู ุงูุฃุฏุงุก - Lazy Loading ููุตูุฑ
// =====================================
function initLazyLoading() {
  const images = document.querySelectorAll('img[loading="lazy"]');
  
  if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src || img.src;
          img.classList.add('loaded');
          observer.unobserve(img);
        }
      });
    });

    images.forEach(img => imageObserver.observe(img));
  }
}

// =====================================
// 16. ุฅุฏุงุฑุฉ ุงูุฃุฎุทุงุก ุงูุนุงูุฉ
// =====================================
function initErrorHandling() {
  window.addEventListener('error', (e) => {
    console.error('โ Error:', e.message);
    // ูููู ุฅุฑุณุงู ุงูุฃุฎุทุงุก ูุฎุฏูุฉ ุชุชุจุน ูุซู Sentry
  });

  window.addEventListener('unhandledrejection', (e) => {
    console.error('โ Unhandled Promise:', e.reason);
  });
}

// =====================================
// 17. ุชุญุณูู ุฅููุงููุฉ ุงููุตูู (Accessibility)
// =====================================
function initAccessibility() {
  // ุฅุถุงูุฉ aria-label ููุฃุฒุฑุงุฑ ุจุฏูู ูุต
  document.querySelectorAll('button:not([aria-label])').forEach(button => {
    if (!button.textContent.trim()) {
      button.setAttribute('aria-label', 'ุฒุฑ');
    }
  });

  // ุฅุถุงูุฉ rel="noopener noreferrer" ููุฑูุงุจุท ุงูุฎุงุฑุฌูุฉ ูููุนูุง ูู ุงูุชุฃุซูุฑ ุนูู ุงูุตูุญุฉ ุงูุญุงููุฉ
  document.querySelectorAll('a[target="_blank"]').forEach(link => {
    const rel = link.getAttribute('rel') || '';
    if (!rel.includes('noopener')) {
      link.setAttribute('rel', (rel + ' noopener noreferrer').trim());
    }
    
    // ุฅุถุงูุฉ event listener ูููุน ุงูุฑุฌูุน ููุตูุญุฉ ุงูุฑุฆูุณูุฉ
    link.addEventListener('click', function(e) {
      // ุงูุณูุงุญ ููุฑุงุจุท ุจุงููุชุญ ุจุดูู ุทุจูุนู
      setTimeout(() => {
        // ุฅุฒุงูุฉ ุงููุฑุฌุน ูููุงูุฐุฉ ุงูุญุงููุฉ
        if (this.target === '_blank') {
          window.opener = null;
        }
      }, 100);
    });
  });

  // ุงูุชุฑููุฒ ุนูู ุงูุนูุงุตุฑ ุงูุชูุงุนููุฉ ุจุงูููุจูุฑุฏ
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
      document.body.classList.add('keyboard-navigation');
    }
  });

  document.addEventListener('mousedown', () => {
    document.body.classList.remove('keyboard-navigation');
  });
}

// =====================================
// 18. Google Analytics
// =====================================
function initGoogleAnalytics() {
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-LV29X3081P');
}

// =====================================
// 19. StatCounter
// =====================================
function initStatCounter() {
  window.sc_project = 13162706;
  window.sc_invisible = 1;
  window.sc_security = "367c0bc1";
}

// =====================================
// 20. ุชููุฆุฉ ุฌููุน ุงููุธุงุฆู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
// =====================================
function init() {
  // ุงูุชููุฆุฉ ุงูุฃุณุงุณูุฉ
  initWelcomeScreen();
  initMobileMenu();
  initDarkMode();
  initLanguageToggle();
  initSmoothScroll();
  initAccessibility();
  initErrorHandling();
  
  // ุงููุญุชูู ุงูุชูุงุนูู
  initTweetCopyButtons();
  updatePetitionCount();
  initLazyLoading();
  
  // ุงูุชุญูููุงุช
  initGoogleAnalytics();
  initStatCounter();
  
  console.log('โ ุชู ุชุญููู ุงููููุน ุจูุฌุงุญ!');
}

// =====================================
// 21. ุชุดุบูู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
// =====================================
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

// =====================================
// 22. ุชุตุฏูุฑ ุงููุธุงุฆู ููุงุณุชุฎุฏุงู ุงูุนุงู
// =====================================
window.campaignSite = {
  openPetition,
  openShare,
  shareToWhatsApp,
  shareToTelegram,
  shareToFacebook,
  shareToTwitter,
  copyHashtag,
  copyPetitionLink,
  toggleSteps,
  showToast,
  trackClick
};